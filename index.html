<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <style>
  /*set slider style*/
  body {
    background-color: black;
    font-size: 14px;
    font-family: 'Garamond';
  }
  p {
    color: black;
    margin: 50px;
  }
  a {
    color: black;
  }
  .axis {
    fill: gray;
  }
  .axis .halo {
    stroke: gray;
    stroke-width: 1px;
    stroke-linecap: round;
  }
  .slider .handle path {
    stroke: white;
    stroke-width: 4px;
    pointer-events: none;
  }
  .slider .handle text {
    color: white;
    text-align: center;
    font-size: 17px;
    font-family: 'Garamond';
  }

</style>
</head>
<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="//d3js.org/d3.geo.projection.v0.min.js"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script>
var sliderPos = 'November 2014';
drawWorld();

function drawWorld() {
var w = 1400;
var h = 800;
map_svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .attr("fill", "#666666");
projection = d3.geo.kavrayskiy7()
                    .scale(w/7)
                    .translate([w/2, h/2])
                    .precision(.1);
var path = d3.geo.path()
                  .projection(projection);
d3.json("world.json", function(json) {
  map_svg.selectAll("path")
      .data(json.features)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("stroke", "#000000")
      .attr("stroke-width", 1);
  drawSlider();
  drawData();
})
}

function drawSlider() {
  formatDate = d3.time.format("%B %Y");
  // parameters
var margin = {
    top: 0,
    right: 100,
    bottom: 0,
    left: 300
  },
  width = 1250 - margin.left - margin.right,
  height = 100 - margin.bottom - margin.top;

// scale function
timeScale = d3.time.scale()
  .domain([new Date('2014-12'), new Date('2015-11')])
  .range([0, width])
  .clamp(true);

// initial value
var startValue = timeScale(new Date('2014-12'));
startingValue = new Date('2014-12');

// defines brush
brush = d3.svg.brush()
  .x(timeScale)
  .extent([startingValue, startingValue])
  .on("brush", brushed);

var svg = d3.select("svg")//.append("svg")
  //.attr("width", width + margin.left + margin.right)
  //.attr("height", 300)//height + margin.top + margin.bottom)
  .append("g")
  // classic transform to position g
  .attr("transform", "translate(" + margin.left + "," + 600 + ")");

svg.append("g")
  .attr("class", "x axis")
// put in middle of screen
.attr("transform", "translate(0," + height / 2 + ")")
// introduce axis
.call(d3.svg.axis()
  .scale(timeScale)
  .orient("bottom")
  .tickFormat(function(d) {
    return formatDate(d);
  })
  .tickSize(0)
  .tickPadding(25)
  .tickValues([timeScale.domain()[0], timeScale.domain()[1]]))
  .select(".domain")
  .select(function() {
    return this.parentNode.appendChild(this.cloneNode(true));
  })
  .attr("class", "halo");

var slider = svg.append("g")
  .attr("class", "slider")
  .call(brush);

slider.selectAll(".extent,.resize")
  .remove();

slider.select(".background")
  .attr("height", height);

handle = slider.append("g")
  .attr("class", "handle")

handle.append("path")
  .attr("transform", "translate(0," + height / 2 + ")")
  .attr("d", "M 0 -20 V 20")

handle.append("text")
  .attr("transform", "translate(" + (-50) + " ," + (height / 2 - 25) + ")");


slider
  .call(brush.event);
 
var button = d3.select("g").append("rect")
    .attr("height", 35)
    .attr("width", 70)
    .attr("transform", "translate(" + (400) + " ," + (100) + ")")
    .attr("stroke", "white")
    .attr("fill", "black");

var buttonText = d3.select("rect").append("rect")
    .attr("height", 30)
    .attr("width", 60)
    .attr("stroke", "white")
    .text("PLAY")
    .attr("font-size", 14)
    .attr("font-family", "Garamond")
    .attr("color", "white");

button.on('click', function() {
  slider
    .transition()
    .duration(10000)
    .call(brush.extent([new Date('2015-11'), new Date('2015-11')]))
    .call(brush.event);
  });
}

// slider event handler
function brushed() {
  var value = brush.extent()[0];

  if (d3.event.sourceEvent) {
    value = timeScale.invert(d3.mouse(this)[0]);
    brush.extent([value, value]);
  }

  handle.attr("transform", "translate(" + timeScale(value) + ",0)");
  handle.select('text').text(formatDate(value));
  oldSliderPos = sliderPos;
  sliderPos = formatDate(value);

  updateCityValues();
}


var sliderPositionHash = {
  "November 2014": "nov",
  "December 2014": "dec",
  "January 2015": "jan",
  "February 2015": "feb",
  "March 2015": "mar",
  "April 2015": "apr",
  "May 2015": "may",
  "June 2015": "jun",
  "July 2015": "jul",
  "August 2015": "aug",
  "September 2015": "sep",
  "October 2015": "oct"
};

function updateCityValues() {
  if (oldSliderPos != sliderPos) {
    //console.log(cities);
    map_svg.selectAll("circle").transition().attr("r", function(cities) {
      if (cities[sliderPositionHash[sliderPos]] > 0) {
        return Math.log(parseInt(cities[sliderPositionHash[sliderPos]]) + 1) * 7;
      }
      else {
        return 0;
      }
      
    });
  }
}

function drawData() {
  var defaultStartMonth = 'nov';
  d3.csv("master_data.csv", function(cities) {
    map_svg.selectAll("circle")
      .data(cities)
      .enter()
      .append("circle")
      .attr("cx", function(d) {
          return projection([d.longitude, d.latitude])[0];
          })
      .attr("cy", function(d) {
          return projection([d.longitude, d.latitude])[1];
          })
      .attr("r", function(d) {
          if (d[defaultStartMonth] > 0) {
            return Math.log(parseInt(d[defaultStartMonth]) + 1) * 7;
          }
          else {
            return 0;
          }
          
          })
      .style("fill", "white")
      .style("opacity", 0.5)
      /*.on("mouseover", cityMouseOver)
      .on("mouseout", cityMouseOut);

      function cityMouseOver() {
        var textBlock = d3.select("g").append("rect")
          .attr("height", 180)
          .attr("width", 180)
          .attr("fill", "black")
          .attr("stroke", "white")
          .attr("transform", "translate(" + (-50) + " ," + (-200) + ")");
      };

      function cityMouseOut() {
        var textOut = d3.select("rect").remove(); //can't get this to work yet, and it messes up the slider
      };*/
      
  })
}

  </script>
</body>
