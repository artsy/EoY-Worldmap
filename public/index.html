L<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <style>
  /*set slider style*/
  body {
    background-color: black;
    font-size: 17px;
    font-family: 'Garamond';
  }
  p {
    color: black;
    margin: 50px;
  }
  a {
    color: black;
  }
  .axis {
    fill: gray;
  }
  .axis .halo {
    stroke: gray;
    stroke-width: 1px;
    stroke-linecap: round;
  }
  .slider .handle path {
    stroke: white;
    stroke-width: 4px;
    pointer-events: none;
  }
  .slider .handle text {
    //fill: white;
    text-align: center;
    font-size: 17px;
    font-family: 'Garamond';
  }

</style>
</head>
<body>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-geo-projection/0.2.15/d3.geo.projection.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  <script>
var sliderPos = 'November 2014';
drawWorld();

function drawWorld() {
var w = 1400;
var h = 800;
map_svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .attr("fill", "#666666");
projection = d3.geo.kavrayskiy7()
                    .scale(w/7)
                    .translate([w/2, h/2])
                    .precision(.1);
var path = d3.geo.path()
                  .projection(projection);
d3.json("world.json", function(json) {
  map_svg.selectAll("path")
      .data(json.features)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("stroke", "#000000")
      .attr("stroke-width", 1);
  drawSlider();
  drawData();
})
}

function drawSlider() {
  formatDate = d3.time.format("%B %Y");

var margin = {
    top: 0,
    right: 100,
    bottom: 0,
    left: 300
  },
  width = 1250 - margin.left - margin.right,
  height = 100 - margin.bottom - margin.top;

// scale function
timeScale = d3.time.scale()
  .domain([new Date('2014-12'), new Date('2015-11')])
  .range([0, width])
  .clamp(true);

// initial value
var startValue = timeScale(new Date('2014-12'));
startingValue = new Date('2014-12');

// defines brush
brush = d3.svg.brush()
  .x(timeScale)
  .extent([startingValue, startingValue])
  .on("brush", brushed);

var svg = d3.select("svg")
  .append("g")
  .attr("transform", "translate(" + margin.left + "," + 600 + ")");

svg.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + height / 2 + ")")
  // introduce axis
  .call(d3.svg.axis()
  .scale(timeScale)
  .orient("bottom")
  .tickFormat(function(d) {
    return formatDate(d);
  })
  .tickSize(0)
  .tickPadding(25)
  .tickValues([timeScale.domain()[0], timeScale.domain()[1]]))
  .select(".domain")
  .select(function() {
    return this.parentNode.appendChild(this.cloneNode(true));
  })
  .attr("class", "halo");

var slider = svg.append("g")
  .attr("class", "slider")
  .call(brush);

slider.selectAll(".extent,.resize")
  .remove();

slider.select(".background")
  .attr("height", height);

handle = slider.append("g")
  .attr("class", "handle")

handle.append("path")
  .attr("transform", "translate(0," + height / 2 + ")")
  .attr("d", "M 0 -20 V 20")

handle.append("text")
  .attr("transform", "translate(" + (-50) + " ," + (height / 2 - 25) + ")");


slider
  .call(brush.event);

var button = d3.select("g").append("rect")
    .attr("id", "button")
    .attr("height", 30)
    .attr("width", 70)
    .attr("transform", "translate(" + (400) + " ," + (100) + ")")
    .attr("stroke", "white")
    .attr("fill", "black");

button.on('click', function() {
  slider
    .transition()
    .duration(20000)
    .call(brush.extent([new Date('2015-11'), new Date('2015-11')]))
    .call(brush.event);

  });
}

// slider event handler
function brushed() {
  var value = brush.extent()[0];

  if (d3.event.sourceEvent) {
    value = timeScale.invert(d3.mouse(this)[0]);
    brush.extent([value, value]);
  }

  handle.attr("transform", "translate(" + timeScale(value) + ",0)");
  handle.select('text').text(formatDate(value));
  oldSliderPos = sliderPos;
  sliderPos = formatDate(value);

  updateCityValues();
}


var sliderPositionHash = {
  "November 2014": "nov",
  "December 2014": "dec",
  "January 2015": "jan",
  "February 2015": "feb",
  "March 2015": "mar",
  "April 2015": "apr",
  "May 2015": "may",
  "June 2015": "jun",
  "July 2015": "jul",
  "August 2015": "aug",
  "September 2015": "sep",
  "October 2015": "oct"
};

function updateCityValues() {
  if (oldSliderPos != sliderPos) {
    //console.log(cities);
    map_svg.selectAll("circle").transition().duration(800)
      .attr("r", function(cities) {
        if (cities[sliderPositionHash[sliderPos]] > 0) {
          return Math.log(parseInt(cities[sliderPositionHash[sliderPos]]) + 1) * 7;
        }
        else {
          return 0;
        }
      });
  }
}

function drawData() {
  var defaultStartMonth = 'nov';
  d3.csv("master_data.csv", function(cities) {
    map_svg.selectAll("circle")
      .data(cities)
      .enter()
      .append("circle")
      .attr("id", function(d) {
          return d.name;
          })
      .attr("cx", function(d) {
          return projection([d.longitude, d.latitude])[0];
          })
      .attr("cy", function(d) {
          return projection([d.longitude, d.latitude])[1];
          })
      .attr("r", function(d) {
          if (d[defaultStartMonth] > 0) {
            return Math.log(parseInt(d[defaultStartMonth]) + 1) * 7;
          }
          else {
            return 0;
          }

          })
      .style("fill", "white")
      .style("opacity", 0.5)
      .on("mouseover", function(d) {
          cityMouseOver(d);
          })
      .on("mouseout", cityMouseOut);
  })
};

function cityMouseOver(d) {
        d3.select("g").append("text")
          .attr("id", "cityName")
          .attr("color", "white")
          .attr("font-size", 15)
          .attr("font-family", "Avant Garde")
          .attr("text-align", "center")
          .attr("transform", "translate(" + (-30) + " ," + (-175) + ")")
          .text(function() {
              return d.name;
          })
        d3.select("g").append("text")
          .attr("id", "cityBody")
          .attr("color", "white")
          .attr("font-size", 17)
          .attr("font-family", "Garamond")
          .attr("text-align", "center")
          .attr("transform", "translate(" + (-30) + " ," + (-150) + ")")
          .text("Lorem Ipsum");
      };

function cityMouseOut() {
        var textOut = d3.select("#cityName").remove()
                      d3.select("#cityBody").remove();
      };

  </script>
</body>
